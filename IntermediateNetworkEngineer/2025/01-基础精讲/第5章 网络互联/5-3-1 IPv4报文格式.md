## 5-3 IPv4

### 5-3-1 IPv4报文格式

![image-20250224202544025](https://img.yatjay.top/md/20250224202544061.png)

一般的，基本IP头部为20个字节，也可用扩展，最大为60字节

- 头部长度（IHL）：该字段占 4 个比特，用来表示 IP 数据报首部的长度。最小值是5，最大值为15，**单位为4字节**。[4比特最多表示0~15，若单位为1个字节，则最多表示15字节，为方便使用，设计时将其单位定义为4个字节，实际使用时，头部长度字段取值范围为5~15，即表示的头部长度为20~60字节]
- TOS：为区分服务字段，用区分服务类型，即QoS字段。
- 总长度字段：该字段占 16 个比特，用来表示 IP 数据报的总长度，也就是**首部和数据载和的长度总和**，最大取值为十进制的**65535(即2<sup>16</sup>-1)**，以字节为单位。
- 标识：主机发送IP报文的序号，每发送一次+1。占 16 个比特，属于同一个数据报的各分片数据报应该具有相同的标识。IP软件维持一个计数器，每产生一个 IP 数据报，计数器的值就加1，并将此值赋给标识字段。IP分片的标识符（Identification）是IP头部中的一个16位字段，用于唯一标识一个IP数据报及其分片。标识符通常由发送主机的IP协议栈通过一个全局计数器生成。每发送一个新的IP数据报，计数器会递增，从而确保短时间内不会重复 **当一个IP数据报需要分片时，每个分片的标识符保持不变，而片偏移和标志位（如MF位）则用于指示分片的顺序和完整性**
- 分片偏移：占 13 个比特，指出分片数据报的数据载荷部分偏移其在原数据报的位置有多远。片偏移以 8 个字节为单位。
- **生存期（TTL）**：用于设置一个数据包**可经过的路由器数量的上限，每经过一台路由器减1**。一般地，最小TTL值为0，最大TTL值为255
- 协议字段：包含一个数字，标识数据报有效载荷部分的数据类型。**常见值：1（ICMP）6（TCP）和17 (UDP)**。该字段占 8 个比特，用来指明 IP 数据报的**数据部分是何种协议数据单元**。常用的一些协议和相应的协议字段值如下表所示。

![image-20230909230000759](https://img.yatjay.top/md/image-20230909230000759.png)

- 头部校验和：仅计算IPv4头部，不检查数据有效载荷部分的正确性。当TTL减一时，头部校验和必须重新计算。

- 选项(任意)字段
  1. 可选字段：可选字段，该字段的长度从 1 个字节到 40 个字节不等，用来支持排错、测量以及安全措施。可选字段增加了 IP 数据报的功能，但这同时也使得IP数据报的首部长度成为可变的，这就增加了每一个路由器处理IP数据报的开销。实际上，可选字段很少被使用
  2. 首部填充字段：该字段在上图中没有显示出来，用来确保首部长度为 4 字节的整数倍，使用全 0 进行填充。首部长度字段是以 4 字节为单位的，换句话说， IP 数据报的首部长度一定是 4 字节的整数倍。由于首部中的可选字段的长度从 1 个字节到 40 个字节不等，那么当 20 字节的固定部分加上 1- 40 个字节长度不等的可变部分，会造成手部长度不是 4 字节的整数倍时，就用取值为全 0 的填充字段填充相应的字节，以确保 IP 数据报的首部长度是 4 字节的整数倍

- IP数据(任意)字段，可变长度，**最大为65515字节(65515+20=65535)**

#### 例题

##### 例题1 

![image-20250224205056557](https://img.yatjay.top/md/20250224205056590.png)

##### 例题2

![image-20250224205112792](https://img.yatjay.top/md/20250224205112824.png)

##### 例题3

![image-20250224205128745](https://img.yatjay.top/md/20250224205128777.png)

##### 例题4

![image-20250224205146617](https://img.yatjay.top/md/20250224205146655.png)

##### 例题5

![image-20250224205441311](https://img.yatjay.top/md/20250224205441350.png)

解析：头部长度（IHL）：该字段占 4 个比特，用来表示 IP 数据报首部的长度。最小值是5，最大值为15，**单位为4字节**。[4比特最多表示0~15，若单位为1个字节，则最多表示15字节，为方便使用，设计时将其单位定义为4个字节，实际使用时，头部长度字段取值范围为5~15，即表示的头部长度为20~60字节]