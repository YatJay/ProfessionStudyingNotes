# IP协议基础

## 网络层的2项功能

| 功能     | 定义                                                         |
| -------- | ------------------------------------------------------------ |
| **路由** | **确定数据包从源到目的地的转发路径，依赖路由协议实现**       |
| **寻址** | **通过IP协议为网络中的每一设备分配唯一IP地址，实现设备间定位与识别** |

## 网络层协议简介

| 协议                                       | 功能概述                                                     | 应用实例                                                     |
| ------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| IP (Internet Protocol)                     | 提供数据包的寻址和路由功能，是Internet的基础协议             | 实现全球互联网上的主机间通信                                 |
| ICMP (Internet Control Message Protocol)   | 用于报告IP数据包传输中的差错情况以及提供简单的网络诊断功能   | `ping`命令使用ICMP回显请求与回显应答报文来检测目的主机是否可达 |
| IGMP (Internet Group Management Protocol)  | 用于管理多播组成员关系，即让网络设备知道主机想接收哪些多播流量 | 支持高效的多播服务，如IPTV直播                               |
| ARP (Address Resolution Protocol)          | 将IP地址解析为MAC地址，以便在局域网中进行数据包的实际传输    | 当主机需要发送数据给同一局域网内的另一主机时，会先执行ARP请求获取其MAC地址 |
| RARP (Reverse Address Resolution Protocol) | 与ARP相反，将MAC地址转换为IP地址                             | 主要用于早期网络中，当设备不知道自己的IP地址时，可以通过RARP获取 |

## IPv4报文格式

注意下面标识的

- IPv4**基本IP头部长度为20字节**
- IPv4**头部的长度最大为60字节**

这是因为，可选字段和填充字段的出现取决于具体的报文需求，它们的长度决定了首部长度的具体值。

![image-20230304210415908](https://img.yatjay.top/md/image-20230304210415908.png)

### IPv4报文字段详解

| 字段名称                                | 位数 | 描述                                                         |
| --------------------------------------- | ---- | ------------------------------------------------------------ |
| 版本（Version）                         | 4    | 标识IP协议的版本，对于IPv4固定为4。                          |
| 首部长度（Internet Header Length, IHL） | 4    | 表示IP报头的长度，单位为32位（4字节）。有效值范围是5（最小值，20字节头部）到15（最大值，60字节头部）。 |
| 服务类型（Type of Service, TOS）        | 8    | 用于QoS，现在多用于DSCP（Differentiated Services Code Point）或IP优先级。 |
| 总长度（Total Length）                  | 16   | 表示整个IP数据报的长度，包括头部和数据部分，单位为字节。     |
| 标识（Identification）                  | 16   | 用于分片重组，同一数据报的所有分片具有相同的标识。           |
| 标志（Flags）                           | 3    | 用于分片控制，其中第1位保留，第2位DF（Don't Fragment）表示禁止分片，第3位MF（More Fragments）表示更多分片。 |
| 分片偏移（Fragment Offset）             | 13   | 用于分片重组，表示该分片在原始数据报中的相对位置。单位为8字节。 |
| **生存时间（Time to Live, TTL）**       | 8    | 数据报在网络中的最大跳数限制，初值0~255，每经过一个路由器减1，到0则被丢弃。 |
| **协议类型（Protocol）**                | 8    | 指示上层协议类型，如**1=ICMP, 6=TCP, 17=UDP**。              |
| 首部校验和（Header Checksum）           | 16   | 用于检查IP头部的完整性。                                     |
| 源IP地址（Source IP Address）           | 32   | 发送方的IP地址。                                             |
| 目的IP地址（Destination IP Address）    | 32   | 接收方的IP地址。                                             |
| 可选字段（Options）                     | 可变 | 如时间戳、记录路由等，不是每次必有，长度由IHL字段决定。      |
| 填充（Padding）                         | 可变 | 用于保持首部长度为32位的整数倍，当有可选字段时使用。         |

## 网关 vs 默认网关

| 特性     | 网关                                                         | 默认网关                                                     |
| -------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 定义     | 网关用来转发来自**不同网段**之间的数据包，是指接收并处理本地网段中主机发送的报文并转发到目的网段的设备，可以是路由器、交换机、服务器等。 | 是一种特殊的网关配置，代表主机在无法直接寻址目的网络时所使用的默认中转地址。 |
| 功能     | 负责不同网络间的数据包转发，实现跨网段通信。                 | 当主机发出的数据包目的地址不在直连的网络内时，自动将数据包转发给预设的网关设备。 |
| 应用范围 | 泛指任何具备网络间数据转发能力的设备或系统。                 | 特指每台主机配置的、用于不确定或未知网络路径情况下的转发地址。 |
| 配置     | 可以是静态配置，也可以动态获取（如DHCP分配）。               | 通常是静态配置在主机的网络设置中，或通过网络协议自动获取。   |
| 实现设备 | 可以是路由器、三层交换机、防火墙、服务器等多种网络设备。     | 实体上可能位于路由器、三层交换机等设备上，是逻辑上的出口点。 |
| 层次     | 网关作为一个概念，涉及网络层及以上的通信处理。               | 默认网关是一个网络层的概念，体现为主机对外通信的基础配置。   |

# IP地址基础

## 十进制与二进制的转换(记住常用幂、位关系)

![image-20240225235514038](https://img.yatjay.top/md/image-20240225235514038.png)

| DEC  | POWER | BIN         | DEC  | POWER  | BIN       |
| ---- | ----- | ----------- | ---- | ------ | --------- |
| 1    | 2^0^  | 0000 0001   | 0    | 2^0^-1 | 0000 0000 |
| 2    | 2^1^  | 0000 0010   | 1    | 2^1^-1 | 0000 0001 |
| 4    | 2^2^  | 0000 0100   | 3    | 2^2^-1 | 0000 0011 |
| 8    | 2^3^  | 0000 1000   | 7    | 2^3^-1 | 0000 0111 |
| 16   | 2^4^  | 0001 0000   | 15   | 2^4^-1 | 0000 1111 |
| 32   | 2^5^  | 0010 0000   | 31   | 2^5^-1 | 0001 1111 |
| 64   | 2^6^  | 0100 0000   | 63   | 2^6^-1 | 0011 1111 |
| 128  | 2^7^  | 1000 0000   | 127  | 2^7^-1 | 0111 1111 |
| 256  | 2^8^  | 1 0000 0000 | 255  | 2^8^-1 | 1111 1111 |

## 分类编址的IPv4地址

| 类别 | 首字节的二进制表示 | 网络号位数 | 主机号位数 | 默认子网掩码  | 范围示例                                    |
| ---- | ------------------ | ---------- | ---------- | ------------- | ------------------------------------------- |
| A    | 0                  | 8          | 24         | 255.0.0.0     | **1**.0.0.0 - **127**.255.255.254           |
| B    | 10                 | 16         | 16         | 255.255.0.0   | **128**.0.0.0 - **191**.255.255.255         |
| C    | 110                | 24         | 8          | 255.255.255.0 | **192**.0.0.0 - **223**.255.255.255         |
| D    | 1110               | N/A        | N/A        | N/A           | **224**.0.0.0 - **239**.255.255.255（组播） |
| E    | 1111               | N/A        | N/A        | N/A           | **240**.0.0.0 - **255**.255.255.255（保留） |

注：
- A类地址中的127.x.x.x（即0111 1111开头的地址）被预留用于本地环回测试（Loopback）
- D类地址用于多播（Multicast）通信，不分配给单个主机，没有默认子网掩码的概念
- E类地址保留作研究使用，同样没有常规的网络号和主机号划分，也没有默认子网掩码
- 若题目不给掩码，则按分类编址IP来确定其默认的网络掩码

## 网络掩码

- 网络掩码与IP地址搭配使用，用于描述一个IP地址中的网络部分及主机部分(其本质是二进制的**与**运算)

- 网络掩码32位，与32位的IP地址一一对应：

  - 掩码中**为1的位**对应IP地址中的**网络位**；

  - 掩码中**为0的位**对应IP地址中的**主机位**。

![image-20230304213244020](https://img.yatjay.top/md/image-20230304213244020.png)

## IP网络的通信类型(三种通信方式对比)

| 通信方式             | 定义                 | 特点                               | 实例                            | 广播域限制                               |
| -------------------- | -------------------- | ---------------------------------- | ------------------------------- | ---------------------------------------- |
| **单播 (Unicast)**   | 点对点通信           | 数据包从源到单一明确的目的地       | PC1直接发送数据给PC2            | 无限制                                   |
| **广播 (Broadcast)** | 点对多通信           | 数据包发送给同一广播域内所有设备   | PC1的消息，同域内PC均接收       | 不穿透路由器，受限于广播域               |
| **组播 (Multicast)** | 点对多（特定组）通信 | 数据包发送给一组有特定兴趣的接收者 | PC1发给所有加入特定组播组的用户 | 受组播成员和组播路由器管理，可跨越广播域 |

**补充说明**：
- **广播**：在以太网中，广播帧会被同一局域网内所有设备接收，但路由器通常会阻止广播流量跨越其接口，以避免广播风暴。
- **单播**：是最常见的通信方式，每个数据包都明确指向一个单独的目标地址。
- **组播**：允许高效地向多个接收者传输信息，需要IGMP（Internet Group Management Protocol）等协议来管理组成员关系，并且依赖组播路由协议来构建组播分发树。通过DHCP Relay（中继代理），可以实现在不同子网间转发DHCP广播请求，将客户端的广播包转换为单播报文至DHCP服务器，再将服务器的单播应答转换为广播或单播返回给客户端。

## IP地址的类型

| 类型     | 定义                           | 特征                                                         | 示例                                            |
| -------- | ------------------------------ | ------------------------------------------------------------ | ----------------------------------------------- |
| 网络地址 | 代表整个网络的地址             | **最小地址**，主机部分全为0                                  | 对于网络192.168.1.0/24，网络地址为192.168.1.0   |
| 广播地址 | 向网络内所有主机发送数据的地址 | **最大地址**，主机部分全为1                                  | 对于网络192.168.1.0/24，广播地址为192.168.1.255 |
| 主机地址 | 分配给网络中每个独立终端的地址 | 在网络地址和广播地址之间，除去网络地址和广播地址本身，可分配给设备作为唯一标识 | 192.168.1.1（假设未被网络地址或广播地址占用）   |

# VLSM可变长度子网划分

VLSM（可变长度子网掩码，Variable Length Subnet Mask）是一种IP地址划分技术，它允许网络管理员根据实际需要为不同的网络或子网分配不同长度的子网掩码。这种方法提供了更灵活的IP地址分配，可以更有效地利用IP地址空间，尤其是在IP地址资源紧张的情况下。

## 划分子网的引入

假设一个公司网络内有500台主机

- 分配一个C类网络IP地址，则可分配给主机使用的IP地址共计2^8^-2=253个，不够用
- 分配一个B类网络IP地址，则可分配给主机使用的IP地址共计2^16^-2=65534个，又会造成极大浪费

为了解决以下问题：

- 标准ABC类网络问题
- IP地址空间浪费
- 一个广播域中PC数量庞大，造成广播风暴，网络可能被广播报文消耗大量资源

因此引入划分子网

## 划分子网的方法

假设我们有一个`172.16.0.0/16`这样一个B类地址，则对于`172.16.0.0`这个网络，拥有2^16^=65535个IP地址

![image-20230913225920530](https://img.yatjay.top/md/image-20230913225920530.png)

**网络位向主机位借位**，从而使得网络部分的位数加长

如下图所示，网络位向主机位借1位作为子网标识，就能划分出2个子网

![image-20230913230219740](https://img.yatjay.top/md/image-20230913230219740.png)

## 子网数量以及每个子网的主机数量计算

![image-20230913231829359](https://img.yatjay.top/md/image-20230913231829359.png)

## 公有IP和私有IP

IPv4地址空间中有一部分特殊的地址，称之为私有IP地址，私有IP地址不能直接访问公网（因特网）的IP，只能在本地使用（RFC 1918文档定义）

若需访问则需在网络出口处做NAT网络地址转换，转换为公网IP

![image-20230913232038333](https://img.yatjay.top/md/image-20230913232038333.png)

# CIDR无类域间路由

## 路由聚合简介

CIDR（无类域间路由，超网Classless Inter-Domain Routing)，又称超网或路由聚合

**路由聚合**：很多个网络聚合成为一条路由，减少路由器的压力

如下图所示，A路由器的路由表中存在4条路由记录，通过路由聚合之后传递给B的则只有1条路由记录，减少了路由器的压力

![image-20230914222943389](https://img.yatjay.top/md/image-20230914222943389.png)

从而，B路由器的路由表可以是`200.200.192.0/22`，而不是像A那样显示4条路由

## 路由聚合的方法

1. 把几条近似路由写成二进制形式，观察哪些二进制位完全一致，则**从该二进制位处进行聚合**
   - 如上图中4条路由记录的二进制位，前22位完全一致，则4条记录可以聚合成为1条记录

2. 再将聚合之后的二进制位写成点分十进制形式

![image-20230914223221647](https://img.yatjay.top/md/image-20230914223221647.png)

## CIDR的作用

| 作用                       | 描述                                                         |
| -------------------------- | ------------------------------------------------------------ |
| **减小路由表项压力**       | 通过路由聚合，将多个连续的网络前缀合并为一个更短的前缀，显著减少了路由器中路由表的条目数量，尤其是对于骨干路由器，减轻了路由表管理的压力。 |
| **缓解IP地址耗尽问题**     | 允许更灵活的IP地址分配，通过聚合小的地址块为大的地址块，减少了地址空间的浪费。**虽然CIDR本身不增加地址空间，但它优化了现有IPv4地址的分配和使用，延缓了IPv4地址完全耗尽的时间**。 |
| **提升路由效率与网络性能** | 减少的路由表项意味着更快的路由查找速度，提升了数据包转发效率，进而改善了整体网络性能。同时，减少了路由更新的传播量，降低了网络带宽的占用。 |
| **增强网络可扩展性**       | 灵活的子网划分机制使得网络可以根据实际需求动态调整，支持未来网络规模的增长，增强了网络架构的可扩展性。 |
| **兼容与平滑过渡**         | CIDR与传统分类地址系统兼容，可在不中断现有服务的前提下逐步部署，为从IPv4向IPv6的过渡提供了平滑的升级路径。 |

## VLSM和CIDR对比

| 特性         | VLSM（可变长度子网掩码）                                     | CIDR（无类域间路由）                                         |
| ------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| **基本概念** | 允许在同一个网络中使用多个不同大小的子网，通过调整子网掩码来适应不同规模网络的IP地址需求。 | 通过在IP地址后附加斜杠和前缀长度来表示地址块，支持路由聚合，减少路由表条目，提高路由效率。 |
| **主要目的** | 提高IP地址分配的灵活性和效率，适应不同部门或区域对地址数量的不同需求。 | 实现IP地址的有效聚合，简化路由表，减少全球互联网路由信息的复杂度。 |
| **应用层面** | 企业内部网络设计，特别是大型企业的复杂网络环境。             | 广泛应用于互联网服务提供商(ISP)和广域网路由，影响全球路由架构。 |
| **操作特点** | 子网细分：增加网络前缀长度，创建更小的子网。                 | 路由聚合：通过减少网络前缀长度来合并多个连续的网络为一个路由条目。 |
| **技术关系** | VLSM是对CIDR的补充，提供了在CIDR分配的地址块内进一步细化子网的能力，二者共同优化IP地址管理和路由。 | CIDR为VLSM提供基础框架，VLSM在此基础上实现更精细化的地址分配策略。 |

# ICMP协议

## ICMP简介

**网际控制报文协议**ICMP (Internet Control Message Protocol）是**网络层**的一个重要协议。ICMP协议用来**在网络设备间传递各种差错和控制信息**，并对于收集各种网络信息、诊断和排除各种网络故障等方面起着至关重要的作用。使用基于ICMP的应用时，需要对ICMP的工作原理非常熟悉。Ping命令使用的正是ICMP协议。

## ICMP的功能

### ICMP重定向

![image-20230914224830935](https://img.yatjay.top/md/image-20230914224830935.png)

| 步骤 | 描述                                                         |
| ---- | ------------------------------------------------------------ |
| 1    | **初始请求**：主机A尝试通过其默认网关RTB向服务器A发送报文。主机A根据配置的默认路由，将数据包发送给网关RTB。 |
| 2    | **路由器检测**：网关RTB接收到报文后，检查报文的目的地，发现更优路径。RTB意识到报文实际上应该直接发往与主机A处于同一网段的另一个网关RTA，因为RTA提供了到达服务器A的更短或更高效的路径。 |
| 3    | **重定向通知**：为了优化未来通信，RTB决定向主机A发送一个ICMP重定向（Redirect）消息。此消息包含了一个建议——主机A应当直接将数据包发送给网关RTA，而非继续通过RTB中转。 |
| 4    | **主机响应**：主机A接收到ICMP重定向消息后，更新其路由表，将通往服务器A的路径更改为直接通过网关RTA。随后，主机A按照新路径直接向RTA发送报文。 |
| 5    | **数据转发完成**：网关RTA接收到报文后，根据其路由配置，将报文正确转发至服务器A，完成通信过程。 |

## ICMP网络诊断

ICMP Echo消息在网络诊断中的应用概览

| ICMP Echo消息类型 | 功能描述                                       | 应用实例                                                     |
| ----------------- | ---------------------------------------------- | ------------------------------------------------------------ |
| Echo Request      | 发送端向目标主机发送的探测消息，用于确认可达性 | `ping`命令发出的就是Echo Request，检查目标是否在线及响应时间 |
| Echo Reply        | 目标主机对收到的Echo Request的响应消息         | 目标收到Echo Request后，返回该消息确认收到及响应时间信息     |

此表格概述了ICMP Echo消息在执行网络诊断时的核心功能与应用实例，展示了如何利用Echo Request和Echo Reply消息进行网络连通性测试、延迟测量、丢包率分析以及辅助进行网络路径追踪。

| 返回信息          | 说明                                                         |
| ----------------- | ------------------------------------------------------------ |
| 报文往返时间(RTT) | 反映数据包从发送到接收再返回的总时间，评估网络延迟情况       |
| 丢包率            | 连续发送多个Echo Request，统计未收到Reply的比例，诊断网络稳定性 |
| 网络路径跟踪      | 结合序列号和响应时间，分析数据包经过的路由节点（结合Traceroute） |

## ICMP报文格式(了解)

![image-20230914225637273](https://img.yatjay.top/md/image-20230914225637273.png)

### ICMP报文格式字段

| 字段名             | 大小（比特） | 描述                                                         |
| ------------------ | ------------ | ------------------------------------------------------------ |
| 类型（Type）       | 8            | 指定ICMP报文的类型，如Echo Request (8), Echo Reply (0), Destination Unreachable (3)等。 |
| 代码（Code）       | 8            | 针对特定类型报文的进一步分类或定义详细信息，如不同类型不可达的具体原因。 |
| 检验和（Checksum） | 16           | 用于确保ICMP报文的完整性，涵盖整个ICMP报文，包括ICMP头部和数据部分。 |
| 数据部分           | 可变         | 根据ICMP报文类型的不同，包含具体的数据负载，如Echo Request/Reply中的标识符和序列号，或者错误报文中包含的原始IP头部和数据报的前8个字节等。 |

### ICMP消息类型和编码类型

（对应上述Type、Code字段）

| 类型（Type） | 代码（Code） | 描述         |
| ------------ | ------------ | ------------ |
| 0            | 0            | Echo Reply   |
| 3            | 0            | 网络不可达   |
| 3            | 1            | 主机不可达   |
| 3            | 2            | 协议不可达   |
| 3            | 3            | 端口不可达   |
| 5            | 0            | 重定向       |
| 8            | 0            | Echo Request |

## ICMP的典型应用

### Ping

![image-20240309155106266](https://img.yatjay.top/md/image-20240309155106266.png)

在华为路由器输入`ping ?`其参数罗列中，常用的是`-a`和`-c`：

- `-a` ：一台路由器有许多接口，如上述RTA有绿色和黄色各个接口，若`ping 10.0.0.2`的RTB路由器，默认通过与之直连在同一网络的绿色接口的IP来ping；而`-a`参数可以指定一个源IP地址(如上图黄色标注的接口IP)去ping
- `-c`：指定ping要发送的ICMP数据包的数量为n个

华为路由器上使用ping命令成功返回结果如下：

### Tracert

tracert/trace route显示数据包在网络传输过程中所经过的每一跳。

![image-20230914230451894](https://img.yatjay.top/md/image-20230914230451894.png)

## 本节提问

1. ping使用的是哪两类ICMP消息？

   ping利用ICMP **Echo Request请求消息（Type值为8）**来发起检测目的可达性。目的端收到ICMP Echo请求消息后，根据IP报文头中的源地址向源端发送ICMP **Echo Reply回复消息(Type值为0)**。

2. 当网络设备收到TTL值为0的IP报文时，会如何操作？

   如果IP数据包在到达目的地之前TTL值已经降为0，则收到IP数据包的网络设备会**丢弃该数据包**，并向源端发送ICMP的*网络不可达*消息通知源端TTL超时。

# ARP协议

## ARP的作用

ARP（Address Resolution Protocol）即地址解析协议：用于实现从IP地址到MAC地址的映射，即**询问目标IP对应的MAC地址**

## ARP协议工作原理

ARP协议（Address Resolution Protocol，地址解析协议）的主要工作原理可以概括为以下几个步骤，并以表格形式展现如下：

| 步骤             | 描述                                                         | 备注                                                         |
| ---------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 1. 发起请求      | 当主机A需要向同一局域网内的主机B发送数据时，首先检查自己的ARP缓存表中是否有主机B的IP地址与其MAC地址的映射关系。如果没有找到，则主机A构造一个ARP请求报文。 | `arp -a`查询本地ARP缓存<br/>![image-20240503214307274](https://img.yatjay.top/md/image-20240503214307274.png) |
| 2. 构建ARP请求包 | ARP请求报文包括：<br/>- **硬件类型**：指明硬件地址类型，例如以太网。<br/>- **协议类型**：通常为IPv4。<br/>- **硬件地址长度**：硬件地址（MAC地址）的长度。<br/>- **协议地址长度**：IP地址的长度。<br/>- **操作码**：置为1，表示ARP请求。<br/>- **发送端硬件地址**：主机A的MAC地址。<br/>- **发送端协议地址**：主机A的IP地址。<br/>- **目标硬件地址**：全0，因为这就是我们要查询的信息。<br/>- **目标协议地址**：主机B的IP地址。 | <br/>![image-20240503214352416](https://img.yatjay.top/md/image-20240503214352416.png) |
| 3. 广播报送      | 主机A将这个ARP请求以广播的形式发送到局域网上，因为此时它还不知道主机B的具体MAC地址。所有接收到该广播的主机都会处理这个ARP请求。 | 下图为接收处理ARP响应图<br/>![image-20240503214543514](https://img.yatjay.top/md/image-20240503214543514.png) |
| 4. 接收并响应    | 主机B识别到该ARP请求中的目标IP地址匹配自己的IP地址后，构建一个ARP响应报文，其中包含自己的MAC地址，并**直接（非广播）回复**给主机A。 | ARP响应<br/>![image-20240503214751757](https://img.yatjay.top/md/image-20240503214751757.png) |
| 5. 更新ARP缓存   | 主机A收到ARP响应后，会更新其ARP缓存表，将主机B的IP地址和MAC地址的映射关系存储起来，以便后续通信直接使用，无需再次发送ARP请求。 | 更新ARP缓存<br/>![image-20240503214701657](https://img.yatjay.top/md/image-20240503214701657.png) |
| 6. 数据传输      | 有了目标MAC地址，主机A就可以封装数据包，包含目标MAC地址，通过数据链路层发送给主机B。 | -                                                            |

### ARP报文字段摘要(了解)

| 字段名         | 长度（字节） | 描述                                   |
| -------------- | ------------ | -------------------------------------- |
| 硬件类型       | 2            | 指定链路层协议类型，如以太网为1        |
| 协议类型       | 2            | 指定高层协议类型，如IPv4为0x0800       |
| 硬件地址长度   | 1            | 硬件地址（MAC）的字节长度，通常为6     |
| 协议地址长度   | 1            | 协议地址（如IP）的字节长度，通常为4    |
| 操作码         | 2            | ARP请求为1，ARP响应为2                 |
| 发送端硬件地址 | 变长         | 发送端MAC地址                          |
| 发送端协议地址 | 变长         | 发送端IP地址                           |
| 目标硬件地址   | 变长         | 全0（请求时），或目标MAC地址（响应时） |
| 目标协议地址   | 变长         | 目标IP地址                             |

## 代理ARP

位于不同网络的网络设备在不配置网关的情况下，可以通过ARP代理实现相互通信。

### 代理ARP（Proxy ARP）工作原理概览

| 步骤              | 描述                                                         |
| ----------------- | ------------------------------------------------------------ |
| 1. 发起ARP请求    | 主机A需要与不在同一广播域但属于同一网段的主机B通信，但主机A只知道主机B的IP地址，不知道其MAC地址。因此，主机A发送一个ARP请求广播，询问主机B的MAC地址。 |
| 2. 路由器截获请求 | 由于两台主机位于不同的广播域，ARP请求广播会被它们之间的路由器（如路由器R）截获。 |
| 3. 代理响应准备   | 路由器R检查其路由表，发现它能够到达主机B所在的网络，因此决定代表主机B响应这个ARP请求。 |
| 4. 发送代理应答   | **路由器R构建**一个ARP响应报文，其中：<br/>- **硬件类型**和**协议类型**与标准ARP响应相同。<br/>- **发送端硬件地址**填写路由器R接口的MAC地址。<br/>- **发送端协议地址**填写主机B的IP地址（即使这不是路由器的IP地址）。<br/>- **目标硬件地址**和**目标协议地址**则分别是主机A的MAC地址和IP地址。 <br/>- 路由器R将此应答直接发送给主机A，而非以广播形式。 |
| 5. 主机A更新缓存  | 主机A收到这个ARP响应后，误以为是主机B的直接回复，因此它更新ARP缓存，记录下主机B的IP地址对应的MAC地址实际上是路由器R接口的MAC地址。 |
| 6. 数据转发       | 之后，当主机A向主机B发送数据时，实际上数据包的MAC目的地址是路由器R的接口MAC地址。路由器R接收到数据后，会根据其内部路由表将数据包正确地转发给主机B。 |
| 7. 返回路径       | 从主机B到主机A的数据传输则遵循正常路由规则，主机B直接回应给路由器R，路由器R再根据路由表转发回主机A，无需再次使用代理ARP。 |
注意事项：

- **透明性**：对于主机A而言，整个过程是透明的，它并不知道数据实际是经由路由器R转发的。
- **适用场景**：代理ARP主要用于没有配置默认网关或特定路由策略的小型网络，以及需要隐藏网络结构或简化配置的情况。
- **潜在风险**：代理ARP可能导致安全风险，如ARP欺骗攻击的可能性增加，以及网络监控和故障排查的复杂度提升。

## 免费ARP

免费ARP（Gratuitous ARP可以用来探测IP地址是否冲突。

### 免费ARP工作原理

| 步骤               | 描述                                                         |
| ------------------ | ------------------------------------------------------------ |
| 1. 发送免费ARP请求 | 主机自发地发送一个ARP请求报文到本地网络，这个请求报文中的**源IP地址**是主机自己的IP地址，而**目标IP地址**也是主机自己的IP地址。 |
| 2. 报文构造        | 免费ARP请求的其它字段类似于普通ARP请求，包括硬件类型、协议类型等，但目标硬件地址设置为全0，因为目标是自己，无需特定MAC地址。 |
| 3. 广播报送        | 免费ARP请求以广播形式在网络中传播，所有接收到该广播的主机都会处理这个请求，尽管它们不会像常规ARP请求那样响应。 |
| 4. 检测IP冲突      | 如果网络中存在另一台主机使用相同的IP地址，这台主机可能会错误地响应免费ARP请求，从而揭示IP地址冲突。 |
| 5. 更新ARP缓存     | 其他主机收到免费ARP后，会更新或确认其ARP缓存中该IP地址与MAC地址的映射关系，即使没有冲突，也起到了刷新和确认信息的作用。 |
| 6. 通告变更        | 当主机改变了自己的MAC地址（如网卡更换、虚拟机迁移等）或者IP地址被重新分配（如DHCP续租）时，发送免费ARP可以帮助迅速通知网络中的其他设备这一变更。 |

### 免费ARP用途总结

- **IP冲突检测**：帮助检测同一局域网内是否有其他设备使用了相同的IP地址。
- **快速通告**：在IP或MAC地址更改后，迅速通告网络中的其他设备，避免通信中断。
- **ARP缓存刷新**：定期发送以刷新其他主机的ARP缓存，确保ARP条目是最新的。
- **网络服务恢复**：如高可用性配置（如HSRP、VRRP）中，用于通告新的活动网关。

免费ARP的发送是非强制性的，但它是维护网络稳定性和提高故障恢复速度的有效机制之一。

## 本节提问

1. 网络设备在什么情况下会发送ARPRequest?
   - 源设备在发送数据给目的设备前，会首先查看自身的ARP缓存，查找ARP缓存中是否存在目的
     设备的IP地址和MAC地址的映射。如果存在则直接使用，如果不存在则会发送ARP Request。

2. 网络设备什么时候会产生免费ARP？
   - 当网络上的一个设备被分配了IP地址或者IP地址发生变更后，可以通过免费ARP来检查IP地址是
     否冲突。
