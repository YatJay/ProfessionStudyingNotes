# 6-18.5-4 IP路由最长匹配原则

## IP路由概念回顾

![image-20231006225549335](https://img.yatjay.top/md/image-20231006225549335.png)

## IP路由查找的最长匹配原则

### 路由条目类型

![image-20231006225634558](https://img.yatjay.top/md/image-20231006225634558.png)

可以看出

- **特定主机路由的目的网络前缀最长**，路由最**具体**。

- **默认路由的目的网络前缀最短**，路由最**模糊**。

### 最长匹配原则

![image-20231006225653768](https://img.yatjay.top/md/image-20231006225653768.png)

当路由器查表转发 IP 数据报时，若有多条路由条目可选，则采用**最长前缀匹配的原则**，选用目的网络前缀最长的那个路由条目进行转发。

![image-20231006225715072](https://img.yatjay.top/md/image-20231006225715072.png)

### 最长匹配原则案例分析

当路由器在将目的IP地址在路由表中执行查找时，采用的原则是“最长匹配原则”，也就是查找**目的IP地址与路由前缀匹配度最长的表项**，使用该表项作为最终数据转发的依据

![image-20231006225952721](https://img.yatjay.top/md/image-20231006225952721.png)

解析：

默认路由0.0.0.0/0是最模糊的，按照最长前缀匹配必然不选此项

将172.16.1.0/24和172.16.0.0/16的网络前缀写成二进制形式

| 类型   | 点分十进制    | 二进制                                          | 匹配结果                     |
| ------ | ------------- | ----------------------------------------------- | ---------------------------- |
| 表项1  | 172.16.1.0/24 | <font color=red>172.16.00000001</font>.00000000 | 属于该网络IP，且是最长匹配   |
| 表项2  | 172.16.0.0/16 | <font color=red>172.16.0000000</font>0.00000000 | 属于该网络IP，但并非最长匹配 |
| 目的IP | 172.16.1.1    | <font color=red>172.16.00000001.00000001</font> | -                            |

## IP路由查找小结

- 不同的前缀（网络号+掩码），在路由表中属于不同的路由
- 相同的前缀（网络号+掩码均相同），且通过不同的协议获取，先比较路由协议优先级，如果路由协议优先级相等，则进一步比较路由度量值。
- 路由查找时采用最长匹配原则，匹配，转发;没有匹配项，则找缺省路由，如果也没有缺省路由，丢弃数据包。
- 路由器的行为是逐跳的，到目标网络的沿途路径每个路由器都必须有关于目标的路由，否则就会丢包。
- 数据通信是双向的，考虑流量的时候，要关注返程流量。

## 路由递归

### 什么是路由递归

路由的下一跳最终必须关联到本地出接口，以及下一跳IP地址，而这个下一跳IP地址必须属于本地直连网络，否则该路由就视为无效。

![image-20231006231234982](https://img.yatjay.top/md/image-20231006231234982.png)

- 在设备进行IP路由查找的时候，递归可能会耗费一定的资源。但在目前行业拓扑驱动的转发机制下，在路由表形成后系统即自动完成路由的递归并创建相应的底层转发表项，而不会在每一个数据包到达都触发一次递归。
- 路由递归在某些协议中被广泛应用，如BGP。
- 在实际业务环境的部署中，如果采用静态路由方式，不建议部署路由递归。
