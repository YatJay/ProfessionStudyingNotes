![](https://gitee.com/YatJay/image/raw/master/img/202203140952733.png)

# 涉及知识

## 文件下载&读取

一些网站由于业务需求，往往需要提供文件查看或文件下载功能，但若对用户查看或下载的文件不做限制，则恶意用户就能够查看或下载任意敏感文件，这就是文件查看与下载漏洞。

尽管文件下载漏洞不会直接触及网站权限，但是会泄露敏感信息，间接导致权限丢失

### 产生原因

1. 存在读文件的函数

2. 读取文件的路径用户可控且未校验或校验不严

3. 输出了文件内容

### 利用



#### 或读取下载常见文件



#### 下载或读取敏感文件

数据库配置文件

各种接口等文件

密匙信息文件

#### 如何获取要下载的文件路径

1. 扫描工具爬行或扫描地址
2. 下载好的文件代码中去分析路径或包含文件路径

### 检测

分白盒、黑盒测试，这里重点讲**手工看参数值及功能点**









### 文件名、参数值、目录符号

```
• download.php?path=
• download.php?file=
• down.php?file=
• data.php?file=
• readfile.php?file=
• read.php?filename=
```







# 演示案例

## Pikachu-文件下载测试——参数值发现漏洞

地址：http://localhost/pentest/pikachu/vul/unsafedownload/down_nba.php

点击球员的名字即可下载图片文件，下载链接(下载时产生的链接)如下

```
http://localhost/pentest/pikachu/vul/unsafedownload/execdownload.php?filename=ai.png
```

而页面中图片的地址为(右键复制图像地址)

```
http://localhost/pentest/pikachu/vul/unsafedownload/download/ai.png
```

也就是说调用`execdownload.php`并传递GET参数来下载文件，设定是去`download`目录下查找提交的文件名，因此如果要下载`execdownload.php`文件，`download`目录下并没有此文件，需要跳级，则构造的下载链接如下

```
http://localhost/pentest/pikachu/vul/unsafedownload/execdownload.php?filename=../execdownload.php
```

访问后即可下载上述提到的源码文件

![](https://gitee.com/YatJay/image/raw/master/img/202203141021715.png)

同理，通过目录扫描、已下载文件内容提及等信息就可以下载其他文件，包括敏感文件

比如下载配置文件`config.inc.php`

```
http://localhost/pentest/pikachu/vul/unsafedownload/execdownload.php?filename=../../../inc/config.inc.php
```

![](https://gitee.com/YatJay/image/raw/master/img/202203141025073.png)

## Zdns-文件下载真实测试——功能点发现漏洞

地址：http://down.znds.com/

得到下载文件的链接如下

```
http://down.znds.com/getdownurl/?s=L3VwZGF0ZS8yMDIyLTAyLTIzL2RhbmdiZWltYXJrZXRfNC4zLjZfMjc5X3puZHMuYXBr
```

其中GET方法提交的s参数值使用了base64加密

解密后结果为

```
http://down.znds.com/getdownurl/?s=/update/2022-02-23/dangbeimarket_4.3.6_279_znds.apk
```

即下载的文件设定是从服务器的update目录下查找，再下载

如果要下载其他文件，获取文件路径之后，还需要使用base64将路径进行加密

下载漏洞在哪里测?下载漏洞怎么判断存在

1. 拿到下载文件的下载链接URL，一般是base64加密，解密后观察路径规律

2. 然后再拿到你想下载的文件的路径，对下载文件路径使用base64加密后构造下载链接



## 小米路由器-文件读取真实测试-漏洞



## RoarCTF2019-文件读取真题复现-比赛

地址：https://buuoj.cn/challenges#%5BRoarCTF%202019%5DEasy%20Java



## 百度杯2017二月-Zone真题复现-比赛拓展



爬虫扫描地址-分析参数名参数值-文件操作安全-对应脚本



修改提交方式测试-读取WEB配置文件WEB-INF/web.xml

访问读取对应地址-访问读取flag对应class文件-(WEB-INF/classes/com/wm/ctf/FlagController.class)







# 涉及资源

https://www.seebug.org/vuldb/ssvid-98122

https://www.ichunqiu.com/battalion?t=1&r=57475

JavaWeb实现文件下载：https://blog.csdn.net/Cheng_May/article/details/78600833：

https://buuoj.cn/challenges#%5BRoarCTF%202019%5DEasy%20Java





