# 3-11-2 虚拟局域网VLAN的实现机制

虚拟局域网微滥技术是在交换机上实现的，需要交换机能够实现以下两大功能

- 一是能够处理带有微滥标记的帧，也就是IEEE 802.1Q帧
- 二是交换机的各端口可以支持不同的端口类型，不同端口类型的端口对针的处理方式有所不同

## IEEE 802.1Q帧

首先来看 IEEE 八零 2 点 e q 针。 h v e 802. 1 Q 帧也称为 Dota one q 帧，他对以太网的麦克针格式进行了扩展，插入了 4 字节的微浪标记。如图所示，这是以太网版本 2 的马克真格式，这是插入微浪标记后的 802. 1 Q 帧的格式，微滥标记的最后 12 个比特称为微滥标识符 v i d。它唯一的标识了以太网真属于哪一个微滥 VID 的取值范围是 0 到4095，其中 0 和 4095 都不用来表示危难，因此用于表示微滥的 Vid 的有效取值范围是 1- 4094。

需要注意的是， 802 点 EQ 针是由交换机来处理的，而不是用户主机来处理的。当交换机收到普通的以太网真时，会将其插入 4 字节的微量标记，将其转变为 802 点 EQ 真，简称为打标签。当交换机转发 802. 1 Q 帧时，可能会删除其 4 字节微烂标记，将其转变为普通以太网真，简称为去标签。未按标记字段的其他内容对我们理解未按划分机制来说并没有什么帮助，因此就不再赘述了。

接下来我们介绍交换机的端口类型。交换机的端口类型一般有以下三种，它们分别是access、Trunk、Hybrid。需要说明的是，思科交换机没有哈不瑞的端口。在介绍这三种交换机端口类型之前，我们首先需要了解一下端口的缺省微量 ID 这个概念。在思科交换机上将其称为本征微滥。例如，思科交换机在用户未配置微滥时，所有端口都默认属于微滥一，借，所有端口的本征微滥都是微滥一，而在华为交换机上将其称为端口微浪 ID 简记为 p v i d。

在我们接下来的介绍中，为了描述方便，我们采用 p v i d，而不是本征微滥。需要注意的是，交换机的每个端口有且仅有一个p、v、i、d。接下来我们首先介绍 access 端口。 access 端口一般用于连接用户计算机，只能属于一个微滥，因此 access 端口的 PV ID 值与端口所属微滥的 ID 相同。如图所示，主机a、b、c、 d 分别连接在交换机的一个端口上，交换机首次上电时，默认配置各端口属于微滥一，也就是各端口的 PV ID 值等于1，默认配置各端口的类型为access，我们用大写字母 a 来表示。

access 端口的接收处理方法是一般只接受未打标签的普通以太网马克针，根据接收针的端口的 PV ID 给帧打标签，借插入 4 字节微滥标记字段中的 Vid 取值与端口的 PV ID 取值相等。我们来举例说明，假设主机 a 发送了一个广播帧，该帧从交换机的端口 1 进入交换机，由于端口 1 的类型是access，它会对接收到的未打标签的普通以太网马可真打标签，也就是插入 4 字节的微滥标记字段。如图所示，由于端口 1 的 PV ID 值等于1，因此所插入的 4 字节微量标记字段中的 Vid 的值也等于1。 access 端口的发送处理方法是，若帧中的 Vid 与端口的 PVID 相等，则去标签后转发该帧，否则不转发。对于本地广播帧中的 Vid 的取值与端口 234 的 PVID 取值都等于1，因此交换机会从这三个端口对针进行去标签转发。再来看这个例子，我们的应用需求是将主机 a 和 b 划归到微浪2，将主机 c 和 d 划归到微软3，这样微量 2 中的广播针不会传送到微软3，微软 3 中的广播针也不会传送到微软2。为了实现这种应用，可以在交换机上创建微浪 2 和微浪3，然后将交换机的端口 1 和 2 划归到微浪2，因此端口 1 和 2 的 PV ID 值等于2。将交换机的端口 3 和 4 划归到微软3，因此端口 3 和 4 的 PV ID 值等于3。

我们来看主机 a 发送广播帧的情况，该帧从交换机的端口 1 进入交换机，由于端口 1 的类型是access，他会对接收到的未打标签的普通以太网马克真打标签，也就是插入 4 字节的未按标记字段，如图所示，由于端口 1 的 PV ID 值等于2，因此所插入的 4 字节微滥标记字段中的 Vid 的值也等于2。广播帧中的 Vid 的取值与端口 2 的 PV ID 取值都等于2，因此交换机会从端口 2 对针进行去标签转发。

我们再来看主机 c 发送广播帧的情况，该针从交换机的端口 3 进入交换机，由于端口 3 的类型是access，它会对接收到的未打标签的普通以太网马克真打标签，也就是插入 4 字节的微滥标记字段，如图所示。由于端口 3 的p、v、i、 d 值等于3，因此所插入的 4 字节微量标记字段中的v、i、 d 的值也等于3。广播帧中的v、i、 d 的取值与端口 4 的p、v、i、 d 取值都等于3，因此交换机会从端口 4 对针进行去标签转发。

接下来我们介绍串个端口。创客端口一般用于交换机之间或交换机与路由器之间的互联。创客端口可以属于多个微软，也就是说创客端口可以接收和发送多个微软的针。用户可以设置创个端口的 PV ID 值，默认情况下，创个端口的 PV ID 值为1。我们来举例说明创个端口的功能，如图所示，两台交换机互连而成的一个交换式以太网，我们的应用需求是将主机a、b、e、 f 划归到微软1，将主机c、d、g、 h 划归到微软2。由于交换机首次上电时默认配置各端口属于微滥一，其相应的 PV ID 值等于1，并且端口的类型为access，因此我们需要对交换机进行相应的配置才能满足应用需求。分别在两个交换机上创建微浪2，并将他们的端口 3 和 4 都划归到微浪2，其相应的 PV ID 值等于2，而两个交换机的端口 1 和 2 保持默认配置即可，也就是属于微滥一，其相应的 PV ID 值等于1。特别需要注意的是，两个交换机互联的端口 5 需要将它们的类型更改为创客类型，而它们的 PV ID 值保持默认的 1 即可。创个端口的发送处理方法是对 Vid 等于 PVID 的帧去标签再转发。假设主机 a 发送了一个广播针，该针从交换机 1 的端口 1 进入交换机。由于端口 1 的类型是access，它会对接收到的未打标签的普通以太网马克真打标签，也就是插入 4 字节的未按标记字段，如图所示，由于端口 1 的 PV ID 值等于1，因此所插入的 4 字节微滥，标记字段中的 Vid 的值也等于1。该广播帧中的 v i d 的取值与端口 2 的 p v i d 值都等于1。

端口 2 的类型是access，因此交换机 1 会从端口 2 对针进行去标签转发。该广播帧中的 Vid 的取值与端口 5 的 PV ID 值都等于1。端口 5 的类型是创可，因此交换机 1 会从端口 5 对针进行去标签转发。很显然，该广播帧会从交换机 2 的端口 5 进入。

交换机 2 创客端口的接收处理方法是接收未打标签的针，根据接收针的端口的 PV ID 给针打标签。借，插入 4 字节微滥标记字段中的 VID 取值与端口的 PVID 取值相等。对于本地，交换机 2 会对接收到的未打标签的普通以太网马克真打标签，也就是插入 4 字节的微滥标记字段。如图所示，由于端口 5 的 PV ID 值等于1，因此所插入的 4 字节微量标记字段中的 Vid 的值也等于1。该广播帧中的v、i、 d 的取值与端口 1 和 2 的p、v、i、 d 值都等于1。端口 1 和 2 的类型都是access，因此交换机 2 会从端口 1 和 2 对针进行去标签转发。

再来看主机 c 发送广播帧的情况，该帧从交换机 1 的端口 3 进入交换机，由于端口 3 的类型是access，它会对接收到的未打标签的普通以太网马克真打标签，也就是插入 4 字节的微滥标记字段。如图所示，由于端口 3 的 PV ID 值等于2，因此所插入的 4 字节微滥标记字段中的 Vid 的值也等于2。

该广播帧中的v、i、 d 的取值与端口 4 的 p v i d 值都等于2，端口 4 的类型是access，因此交换机 1 会从端口 4 对针进行去标签转发，该广播帧中的 Vid 的取值与端口 5 的 PVID 值不相等。由于创客端口对 Vid 不等于 PVID 的针是直接转发的，因此交换机 1 会从端口 5 对针直接转发，也就是不去掉标签而带着标签直接转发。很显然，该 802. 1 Q 广播帧会从交换机 2 的端口 5 进入。交换机 2 创个端口接收已打标签的 802. 1 Q 帧。该广播帧中的 v i d 的取值与端口 3 和 4 的p， v i d 值都等于2，端口 3 和 4 的类型都是 access 类型，因此交换机 2 会从端口 3 和 4 对针进行去标签转发。

通过本地可以看出，在由多个交换机互连而成的交换式以太网中划分微滥时，连接主机的交换机端口应设置为 access 类型，交换机之间互联的端口应设置为 trunk 类型。接下来请同学们做一个练习题，以加深对 access 端口和创个端口功能的理解。请大家暂停播放视频思考一下，给出你的答案。

本题的答案如下所示，希望大家都能解答正确。最后我们简单介绍一下华为交换机私有的海博瑞的端口类型。海博瑞的端口即可用于交换机之间或交换机与路由器之间的互联，这一点与创客端口相同，也可用于交换机与用户计算机之间的互联，这一点又与 access 端口相同。除此之外， hybrid 端口的绝大部分功能与创客端口相同。不同点在于海柏瑞的端口的发送处理方法。哈布瑞的端口会查看真的 Vid 是否在端口的去标签列表中，若存在则去标签后再转发，若不存在则直接转发。

接下来，我们通过一个简单的应用实例来说明海博瑞的端口的功能。主机a、b、 c 连接在同一个交换机的不同接口上。请利用海博瑞的端口的功能实现以下应用需求， a 和 b 都能与 c 相互通信，但 a 与 b 不能相互通信。如图所示。我们可以将这三台主机所连接的交换机的三个端口划分到不同的微量，并且端口类型设置为hybrid。假设这三个微滥分别是微滥十、微滥二十、微滥三十，相应的 PV ID 分别为十2030。在端口 1 的去标签列表中配置微滥时和微滥30。在端口 2 的区标签列表中配置微量 20 和微量30。在端口 3 的区标签列表中配置微量10、微量20、微量30。

主机 a 给 c 发送数据帧，该帧从交换机的端口 1 进入交换机。由于端口译的类型是hybrid，它会对接收到的未打标签的普通以太网马可真打标签，也就是插入 4 字节的微乱标记字段。如图所示。由于端口 1 的 PV ID 值等于10，因此所插入的 4 字节微滥标记字段中的 Vid 的值也等于10，该针将从端口 3 转发。由于帧中的 Vid 的取值在端口 3 的去标签列表中，因此该帧会被区标签转发，这样主机 c 就可以收到主机 a 发送的数据帧。

同理，主机 c 给 a 发送数据帧，主机 a 同样可以收到，我们就不再演示了。那么主机 b 给 c 发送数据帧的具体过程又如何？如图所示，同理，主机 c 给 b 发送数据帧，主机 b 同样可以收到，我们就不再演示了。再来看看主机 a 给 b 发送数据帧的情况。该针从交换机的端口 1 进入交换机，给该帧打标签，其中 Vid 取之为10，该帧将从端口 2 转发。由于帧中的 Vid 的取值不在端口 2 的去标签列表中，因此该帧被直接转发，这样主机 b 就会收到一个带有微滥标记的 802 点 EQ 针，但是主机 b 可以识别普通以太网马克针，而不能识别 802 点 EQ 针，只能丢弃该针。同理，主机 b 给 a 发送的普通以太网麦克针，主机 a 收到的却是 802. 1 Q 帧，无法识别而丢弃。本节课到这里就结束了，我们将本节课的内容小结如下，同学们，我们下节课再见。